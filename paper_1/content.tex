\chapter{Энергетическое разрешение детектора}

Одним из самых важных параметров детектора является энергетическое разрешение.
В этой главе мы найдем предельное энергетическое разрешение детектора и найдем основные факторы, препятствующие его улучшению.
\section{Детектор на основе ФЭУ и сцитиллятора}

Детектор на основе ФЭУ и сцинтиллятора - одни из самых простых детекторов, но в тоже время обладающий высоким энергетическим и временным разрешением.
Процесс распространения света в детекторе представлен на .
Сначала происходит поглощение рентгеновского фотона в толще сцинтиллятора.
Это приводит к появлению $N_{born}$ световых фотонов.
Распространяясь, свет может отражаться от стенок сцинтиллятора, поглощаться, преломляться и выходить наружу (в отсутствие отражателя) или же преломляться и проходить в оптическую смазку.
После оптической смазки свет падает на стекло ФЭУ и лишь после этого достигает фотокатода.
Достигнув фотокатода, часть света отразится от границы стекло-фотокатод.
Коэффициент отражения фотокатода обзначим $r_{cath}$.
Таким образом, лишь некоторая часть $N_{abs}$ фотонов поглотится в фотокатоде.
Фотокатод имеет некоторую конверсионную эффективность $Conv$.
Под конверсионной эффективностью понимается отношение среднего числа испущенных фотоэлектронов к среднего числу фотонов, поглощенных в толще фотокатода.
После прохождения фотокатода свет преобразуется в $N_{p.e.}^{init}$ фотоэлектронов.
Однако из-за неидеальности сбора фотоэлектронов (преимущественно на первый динод) лишь некоторая доля фотоэлектронов $N_{p.e.}$ сможет развить электронную лавину.
Неидеальность сбора фотоэлектронов описывается параметром $\eta$,
который характеризует отношение среднего числа зарегистрированных фотоэлектронов $E[N_{p.e.}]$ к среднему числу испущенных фотоэлектронов $N_{p.e.}^{init}$.
Далее при взаимодействии с динодами произойдет усиление и образуются $N_{e}$ электронов.

Величины $r_{cath}$, $Conv$, $\eta$ зависят от длины волны падающего света и характеризуют конкретный ФЭУ.
Однако на практике обычно измеряют производную от них величину - квантовую эффективность.
Для этого ФЭУ освещают нормальным пучком света и считают число зарегистрированных фотоэлектронов $E[N_{p.e.}]$.
Если известно число падающих фотонов $E[N_0]$, то квантовая эффективность определяется следующим образом: $\varepsilon = E[N_{p.e.}] / E[N_0]$.
При сборе света со сцинтиллятора угол падения света на фотокатод не будет нормальным, однако, как было показано в \cite{Optical properties of bialkali photocathodes},
 если угол падения не превышает $40^{\circ}$, то $r_{cath}$ остается практически константой, 
 а $Conv$ и вовсе не зависит от угла падения света \cite{M.D. Lay}, поэтому в первом приближении можно описывать ФУЭ лишь одной характеристикой $\varepsilon$.
 
\begin{figure}[h]
\center{\includegraphics[width=1\linewidth]{detector}}
\caption{Детектор на основе ФЭУ и сцинтиллятора со схематичным представлением распространения фотонов и электронов.}
\label{ris:image}
\end{figure} 

\subsection{ФЭУ без шумов}
Чтобы написать формулу для энергетического разрешения, рассмотрим подробно процесс формирования сигнала.
Основные используемые величины: 

$N_{born}$  - число световых фотонов, родившихся в сцинтилляторе.

$N_{abs}$ - число световых фотонов, поглощенных в фотокатоде

$N_{p.e.}$ - число зарегистрированных фотоэлектронов

$N_{e}$ - число электронов, собранных на последнем аноде ФЭУ

Все эти величины связаны следующими соотношениями:

$$N_{abs} = \sum \limits_{i=0}^{N_{born}} n_{abs_{i}}$$

$$N_{p.e.} = \sum \limits_{i=0}^{N_{abs}} n_{p.e._{i}}$$

$$N_{e} = \sum \limits_{i=0}^{N_{p.e.}} G_{i}$$

$n_{abs}$ - число световых фотонов, поглощенных в фотокатоде, если в сцинтилляторе родился один световой фотон, $n_{abs} \in \{0, 1\}$.

$n_{p.e.}$ - число зарегистрированных фотоэлектронов, если в фотокатоде поглотился один световой фотон, $n_{p.e.} \in \{0, 1\}$.

$G$ - число электронов, собранных на ФЭУ, при условии, что родился один фотоэлектрон

В процессе измерений мы регистрируем число электронов $N_{e}$. Энергетическое разрешение будет определяться следующим образом:
$$ \delta E = \Delta \cdot \frac{\sqrt{Var[N_{e}]}} {E[N_{e}]}, $$
где $\Delta = 2 \cdot \sqrt{2 \cdot \ln(2)} \approx 2.36$.
В дальнейшем более удобно будет использовать квадрат этой величины ${\delta E}^2$, деленный на $\Delta^2$.

Сцинтиллятор имеет некий спектр излучения с плотностью вероятности $P(\lambda)$, поэтому необходимо проинтегрировать сигнал и шум:
$$\delta E^2 / \Delta^2 = \frac{\int Var[N_e] \cdot P(\lambda)^2 d\lambda}{\left(\int E[N_e] \cdot P(\lambda) d\lambda \right)^2}$$

Рассмотрим для простоты случай, когда сцинтиллятор излучает свет на одной длине волны.

Чтобы посчитать мат. ожидание и дисперсию величины, представляющей собой сумму флуктуирующих величин, где число слагаемых тоже является случайной величиной, необходимо воспользоваться тождеством Вальда.
Данное тождество утверждает следующее:
$$ E \left[ \sum \limits_{i=0}^{N} X_{i} \right] = E[N] \cdot E[X] $$

Как следствие этого тождества получаем выражение для дисперсии:
$$ Var \left[ \sum \limits_{i=0}^{N} X_{i} \right] = Var[N] \cdot ( E[X] )^2 + Var[X] \cdot E[N]$$

Воспользовавшись этими двумя выражениями, выразим величину ${\delta E}^2 / \Delta^2$ через базовые величины $N_{born}$, $n_{abs}$, $n_{p.e.}$, $G$, которые описывают детектор:

\begin{eqnarray}\label{eq:ener_resol_base}
{\delta E}^2 / \Delta^2 = \frac{Var[N_{born}]}{(E[N_{born}])^2} + \frac{Var[n_{abs}]}{(E[n_{abs}])^2} \cdot \frac{1}{E[N_{born}]} + \\ \nonumber
 \frac{Var[n_{p.e.}]}{(E[n_{p.e.}])^2} \cdot \frac{1}{E[N_{abs}]} + \frac{Var[G]}{(E[G])^2} \cdot \frac{1}{E[N_{p.e.}]}
\end{eqnarray}

Рассмотрим каждое из слагаемых подробнее.

Слагаемое $\frac{Var[N_{born}]}{(E[N_{born}])^2}$ описывает вклад флуктуации числа фотонов, рожденных в сцинтилляторе. Стоит заметить, что $Var[N_{born}] \neq E[N_{born}] $, то есть пуассоновская статистика не выполняется. Детальное описание факторов, влияющих на собственное энергетическое разрешение сцинтиллятора можно найти в \cite{Qi_Li}.

Выражение $\frac{Var[n_{abs}]}{(E[n_{abs}])^2} \cdot \frac{1}{E[N_{born}]}$ описывает вклад флуктуаций сбора света на фотокатод. Существует множество факторов, влияющих на величину флуктуации: разброс точки взаимодействия рентгеновского кванта и сцинтиллятора, флуктуации поглощения световых фотонов в толще сцинтиллятора, оптической смазки или фотокатода и т.д. Чтобы найти эту величину, необходимо смоделировать распространите света в сцинтилляторе. Также тут присутствует фактор подавления $\frac{1}{E[N_{born}]}$: чем больше число рожденных фотонов, тем меньше светосбор влияет на энергетическое разрешение.

Следующее слагаемое $\frac{Var[n_{p.e.}]}{(E[n_{p.e.}])^2} \cdot \frac{1}{E[N_{abs}]}$ описывает флуктуации числа регистрируемых фотонов, вызванные конечной конверсионной эффективностью фотокатода.
Величина $n_{p.e.}$ имеет распределение Бернулли, причем мат. ожидание рано коэффициенту конверсии $E[n_{p.e.}] = Conv$ и $Var[n_{p.e.}] = Conv(1 - Conv)$.
Таким образом, начальное выражение можно упростить до следующего: $\frac{1 - Conv}{Conv} \cdot \frac{1}{E[N_{abs}]}$.

Последнее слагаемое $\frac{Var[G]}{(E[G])^2} \cdot \frac{1}{E[N_{p.e.}]}$ описывает флуктуации усиления. Флуктуации усиления обычно не превышают $10-20\%$ \cite{Characterization and Simulation of the Response}, а наличие фактора подавления $E[N_{p.e.}]$ делает вклад данного слагаемого в энергетическое разрешение еще меньше.


\subsection{Учет собственных шумов ФЭУ и шумов электроники}
В предыдущем разделе описана самая простая формула для энергетического разрешения.
Однако, для полноты картины, следует учесть еще шум ФЭУ и шум электроники.

Если раньше предполагалось бесконечное время интегрирования сигнала,то теперь оно конечно.
Обозначим его $t_{gate}$. Предположим, что время интегрирования в несколько раз больше характерного времени затухания сигнала, и мы собираем весть заряд от сигнала.
Отличие от предыдущего случая будет в том, что теперь в итоговый заряд будет давать вклад не только сигнал, но и шум. Число регистрируемых шумовых фотоэлектронов $N_{DC}$ будет подчиняться статистике Пуассона с параметром, равным произведению времени интегрирования $t_{gate}$ на частоту шумовых импульсов $\nu_{DC}$:

\begin{eqnarray}
N_{p.e.} = \sum \limits_{i=0}^{N_{abs}} n_{p.e._{i}} + N_{DC} \nonumber
\end{eqnarray}

При наличии шумов в формуле для энергетического разрешения уже не получится сократить некоторые члены в числителе и знаменателе как в (\ref{eq:ener_resol_base}):

\begin{eqnarray}
{\delta E}^2 / \Delta^2 = \frac{Var[N_{p.e.}]}{(E[N_{p.e.}])^2} + \frac{Var[G]}{(E[G])^2} \cdot \frac{1}{E[N_{p.e.}]}, \nonumber
\end{eqnarray}

причем $E[N_{DC}] = Var[N_{DC}] = t_{gate} \cdot \nu_{DC}$

\begin{eqnarray}
E[N_{p.e.}] = E[N_{abs}] \cdot E[n_{p.e.}] + E[N_{DC}] \nonumber
\end{eqnarray}

\begin{eqnarray}
Var[N_{p.e.}] = Var[N_{abs}] \cdot (E[n_{p.e.}])^2 + Var[N_{DC}] \nonumber
\end{eqnarray}

\section{Энергетическое разрешение SiPM}
С точки зрения энергетического разрешения SiPM отличается от ФЭУ наличием двух дополнительных факторов, влияющих на шум: послеимпульсами и кросстоками.

\subsection{Учет кросстоков}

Кроссток или оптический кроссток - это эффект срабатывания соседних ячеек SiPM из-за излучения оптических фотонов во время образования лавины в исходном пикселе.
Поскольку свет распространяется практически мгновенно, то данный эффект не приводит к каким-либо временным сдвигам. Чтобы учесть влияние кросстока на энергетическое разрешение,
необходимо модифицировать функцию плотности вероятности величины $n_{p.e.}$.
Если раньше данная величина имела распределение Бернулли с параметром $E[n_{p.e.}]$, то теперь распределение будет другим.
Чтобы найти это распределение нужно знать квантовую эффективность регистрации (или коэффициент конверсии,
т.к. все зависит от того, какую величину рассматривать в качестве базовой) и вероятность срабатывания соседней ячейки из-за кросстока.
Детальное описание вероятностей срабатывания ячеек из-за кросстока можно найти в \cite{Modeling crosstalk in silicon photomultipliers}.
В этой статье рассматриваются несколько моделей распространения фотонов, но утверждается, что для большинства моделей SiPM наиболее правдоподобной является модель 4-х соседей.
Вероятность срабатывания N ячеек выражается через параметр $p$, который описывает вероятность того, что соседний пиксель сработает из-за кросстока.
Вычислить параметр $p$ можно, зная полную вероятность кросстока $p_{total}$ (одно или больше кросстоковых событий): $(1 - p)^{4} = 1 - p_{total}$.
В дальнейшем удобно будет ввести величину $q = 1 - p$.
Таким образом, зная квантовую эффективность $\varepsilon$ и вероятность кросстока $p$, получим следующую плотность вероятности в модели 4-х соседей.


\begin{tabular}{|c|c|}
  \hline
  суммарное число сработавших ячеек& плотность вероятности $n_{p.e.}$ \\
  \hline

  \hline
  1 & $\varepsilon \cdot q^4$ \\
  \hline
  2 & $\varepsilon \cdot 4 p q^6$ \\
  \hline
  3 & $ \varepsilon \cdot 18 p^2 q^8$ \\
  \hline
  4 & $\varepsilon \cdot p^3 q^8 [1 + 3q + 18 q^2]$ \\
  \hline
  5 & $\varepsilon \cdot 5p^4 q^{10} [8 + 24q + 55q^2]$ \\
  \hline
  $N > 5$ & $\simeq\varepsilon \cdot P(5) \left[ 1 - \frac{P(5)}{1 - \sum \limits_{k=1}^{4} P(k) } \right]^{N - 5}$ \\
  \hline

\end{tabular}

Чтобы учесть вклад кросстоков в энергетическое разрешение необходимо пересчитать $E[n_{p.e}]$ и $Var[n_{p.e.}]$с учетом модифицированной плотности вероятности,
причем в отсутствии шумов SiPM формула для энергетического разрешения останется прежней (\ref{eq:ener_resol_base}).


Если учесть еще и собственные шумы SiPM, то необходимо изменить величину $N_{p.e.}$:
\begin{eqnarray}
N_{p.e.} = \sum \limits_{i=0}^{N_{abs}} n_{p.e._{i}} + \sum \limits_{i=0}^{N_{DC}} n_{p.e._{i}}^{DC}, \nonumber
\end{eqnarray}

где величина $n_{p.e.}^{DC}$ - число зарегистрированных фотоэлектронов, если произошел одиночный шумовой (тепловой) импульс.
Данная величина имеет тоже распределение,что и $n_{p.e.}$, только с параметром $\varepsilon = 1$.
Таким образом, получим следующие значения для мат. ожидания и дисперсии:

\begin{eqnarray}\label{eq:E[N]}
E[N_{p.e.}] = E[n_{p.e.}^{DC}] \cdot \left\{ \varepsilon \cdot E[N_{abs}] + E[N_{DC}] \right\}
\end{eqnarray}

\begin{eqnarray}\label{eq:Var[N]}
Var[N_{p.e.}] = \left\{ Var[N_{abs}] \cdot (E[n_{p.e.}^{DC}])^2 + Var[n_{p.e.}^{DC}] \cdot E[N_{abs}] \right\} \cdot \varepsilon^2 + \nonumber \\
 \left\{ (E[n_{p.e.}^{DC}])^2 + Var[n_{p.e.}^{DC}] \right\} \cdot E[N_{DC}]
\end{eqnarray}


\subsection{Учет послеимпульсов}

Послеимпульс - сигнал, появляющийся через некоторый промежуток времени после основного сигнала.
Причина появления послеимпульсов заключается в захвате электронов в ловушки во время лавины с их последующим высвобождение через промежуток времени,
обычно длящийся от нескольких наносекунд до нескольких микросекунд \cite{Characterisation Studies of Silicon Photomultipliers}.
После срабатывания основного сигнала напряжение на ячейке будет восстанавливаться к исходному значению к течение времени восстановления ячейки, которое мы обозначим $\tau_{r}$.
Таким образом, если послеимпульс произошел после основного сигнала через время $\Delta t$,
то доля заряда в послеимпульсе относительно основного сигнала будет выражаться следующим образом: $\xi(\Delta t) = 1 - \exp \left( -\Delta t / \tau_{r} \right)$.
Плотность вероятности величины $\Delta t$ описывается двумя затухающими экспонентами \cite{After-pulsingandcross-talkinmulti-pixelphotoncounters}:
$$ f(\Delta t) = A_{s} \cdot \exp(-\Delta t / \tau_{s}) + A_{f} \cdot \exp(-\Delta t / \tau_{f}), $$
где $\tau_{s}$ и $\tau_{f}$ среднее время, проходящее между двумя импульсами для быстрой и медленной компоненты, а $A_{s}$ и $A_{f}$ - нормировочные константы.

В большинстве приложений время интегрирования $t_{gate}$ выбирают в несколько раз больше времени восстановления ячейки $\tau_{r}$.
Мы предположим что, $t_{gate}$ достаточно большое и в несколько раз превышает и $\tau_{f}$.
Также для простоты пренебрежем вкладом медленной компоненты послеимпульса, т.к. её вероятность намного меньше вероятности быстрой компоненты.


Чтобы учесть вклад послеимпульсов в энергетическое разрешение необходимо ввести поправку
 на число зарегистрированных электронов:
$$N_{e} = \sum \limits_{i=0}^{N_{p.e.}} (G_{i} + A_{i}) $$

Случайная величина $G$ имеет распределение Гаусса и описывает по-прежнему флуктуации усиления, а величина $A$ описывает послеимпульсы.
На данный момент мы не знаем точную форму плотности вероятности величины $A$, поэтому найдем из эксперимента мат. ожидание и дисперсию суммарной величины $G_{tot} = G + A$.

Итого, если сцинтиллятор излучает на одной длине волны, а в качестве детектора используется SiPM, то можно написать следующее выражение для энергетического разрешения:

$$\delta E^2 / \Delta^2= \frac{Var[N_{p.e.}]}{(E[N_{p.e.}])^2} + \frac{Var[G_{tot}]}{(E[G_{tot}])^2} \cdot \frac{1}{E[N_{p.e.}]},$$

где определения величин $E[N_{p.e.}]$ и $Var[N_{p.e.}]$ берутся из формул (\ref{eq:E[N]}) и (\ref{eq:Var[N]}).
