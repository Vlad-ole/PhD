\part{Энергетическое разрешение детектора}

Одним из самых важных параметров детектора является энергетическое разрешение.
В этой главе мы найдем предельное энергетическое разрешение детектора на основе кремневого лавинного фотодиода (SiPM) или фотоэлектронного умножителя (ФЭУ)
и сцинтиллятора и найдем основные факторы, препятствующие его улучшению.
\section{Детектор на основе ФЭУ и сцитиллятора}
\subsection{Распространение света в ФЭУ}
Детектор на основе ФЭУ и сцинтиллятора - одни из самых простых детекторов, но в тоже время обладающий высоким энергетическим и временным разрешением.
Процесс распространения света в детекторе представлен на \ref{ris:image}.
Сначала происходит поглощение рентгеновского фотона в толще сцинтиллятора.
Это приводит к появлению $N_{born}$ световых фотонов.
Распространяясь, свет может отражаться от стенок сцинтиллятора, поглощаться, преломляться и выходить наружу (в отсутствие отражателя) или же преломляться и проходить в оптическую смазку.
После оптической смазки свет падает на стекло ФЭУ и лишь после этого достигает фотокатода.
Достигнув фотокатода, часть света отразится от границы стекло-фотокатод.
Коэффициент отражения фотокатода обзначим $r_{cath}$.
Таким образом, лишь некоторая часть $N_{abs}$ фотонов поглотится в фотокатоде.
Фотокатод имеет некоторую конверсионную эффективность $Conv$.
Под конверсионной эффективностью понимается отношение среднего числа испущенных фотоэлектронов к среднего числу фотонов, поглощенных в толще фотокатода.
После прохождения фотокатода свет преобразуется в $N_{p.e.}^{init}$ фотоэлектронов.
Однако из-за неидеальности сбора фотоэлектронов (преимущественно на первый динод) лишь некоторая доля фотоэлектронов $N_{p.e.}$ сможет развить электронную лавину.
Неидеальность сбора фотоэлектронов описывается параметром $\eta$,
который характеризует отношение среднего числа зарегистрированных фотоэлектронов $E[N_{p.e.}]$ к среднему числу испущенных фотоэлектронов $N_{p.e.}^{init}$.
Далее при взаимодействии с динодами произойдет усиление и образуются $N_{e}$ электронов.

Величины $r_{cath}$, $Conv$, $\eta$ зависят от длины волны падающего света и характеризуют конкретный ФЭУ.
Однако на практике обычно измеряют производную от них величину - квантовую эффективность.
Для этого ФЭУ освещают нормальным пучком света и считают число зарегистрированных фотоэлектронов $E[N_{p.e.}]$.
Если известно число падающих фотонов $E[N_0]$, то квантовая эффективность определяется следующим образом: $\varepsilon = E[N_{p.e.}] / E[N_0]$.
При сборе света со сцинтиллятора угол падения света на фотокатод не будет нормальным, однако, как было показано в \cite{Optical properties of bialkali photocathodes},
 если угол падения не превышает $40^{\circ}$, то $r_{cath}$ остается практически константой,
 а $Conv$ и вовсе не зависит от угла падения света \cite{M.D. Lay}, поэтому в первом приближении можно описывать ФУЭ лишь одной характеристикой - квантовой эффективностью $\varepsilon$.

\begin{figure}[h]
\center{\includegraphics[width=8cm]{detector}}
\caption{Детектор на основе ФЭУ и сцинтиллятора со схематичным представлением распространения фотонов и электронов.}
\label{ris:image}
\end{figure}

\subsection{ФЭУ без шумов}
Чтобы написать формулу для энергетического разрешения, рассмотрим подробно процесс формирования сигнала.
Основные используемые величины:

$N_{born}$  - число световых фотонов, родившихся в сцинтилляторе.

$N_{abs}$ - число световых фотонов, поглощенных в фотокатоде

$N_{p.e.}$ - число зарегистрированных фотоэлектронов

$N_{e}$ - число электронов, собранных на последнем аноде ФЭУ

Все эти величины связаны следующими соотношениями:

$$N_{abs} = \sum \limits_{i=0}^{N_{born}} n_{abs_{i}}$$

$$N_{p.e.} = \sum \limits_{i=0}^{N_{abs}} n_{p.e._{i}}$$

$$N_{e} = \sum \limits_{i=0}^{N_{p.e.}} G_{i}$$

$n_{abs}$ - число световых фотонов, поглощенных в фотокатоде, если в сцинтилляторе родился один световой фотон, $n_{abs} \in \{0, 1\}$.

$n_{p.e.}$ - число зарегистрированных фотоэлектронов, если в фотокатоде поглотился один световой фотон, $n_{p.e.} \in \{0, 1\}$.

$G$ - число электронов, собранных на ФЭУ, при условии, что регистрируется один фотоэлектрон

В процессе измерений мы регистрируем число электронов $N_{e}$. Энергетическое разрешение будет определяться следующим образом:
$$ \delta E = \Delta \cdot \frac{\sqrt{Var[N_{e}]}} {E[N_{e}]}, $$
где $\Delta = 2 \cdot \sqrt{2 \cdot \ln(2)} \approx 2.36$.
В дальнейшем более удобно будет использовать квадрат этой величины ${\delta E}^2$, деленный на $\Delta^2$.

Сцинтиллятор имеет некий спектр излучения с плотностью вероятности $P(\lambda)$, поэтому необходимо проинтегрировать сигнал и шум:
$$\delta E^2 / \Delta^2 = \frac{\int Var[N_e] \cdot P(\lambda)^2 d\lambda}{\left(\int E[N_e] \cdot P(\lambda) d\lambda \right)^2}$$

Рассмотрим для простоты случай, когда сцинтиллятор излучает свет на одной длине волны.

Чтобы посчитать мат. ожидание и дисперсию величины, представляющей собой сумму флуктуирующих величин, где число слагаемых тоже является случайной величиной, необходимо воспользоваться тождеством Вальда.
Данное тождество утверждает следующее:
$$ E \left[ \sum \limits_{i=0}^{N} X_{i} \right] = E[N] \cdot E[X] $$

Как следствие этого тождества получаем выражение для дисперсии:
$$ Var \left[ \sum \limits_{i=0}^{N} X_{i} \right] = Var[N] \cdot ( E[X] )^2 + Var[X] \cdot E[N]$$

Воспользовавшись этими двумя выражениями, выразим величину ${\delta E}^2 / \Delta^2$ через базовые величины $N_{born}$, $n_{abs}$, $n_{p.e.}$, $G$, которые описывают детектор:

\begin{eqnarray}\label{eq:ener_resol_base}
{\delta E}^2 / \Delta^2 = \frac{Var[N_{born}]}{(E[N_{born}])^2} + \frac{Var[n_{abs}]}{(E[n_{abs}])^2} \cdot \frac{1}{E[N_{born}]} + \\ \nonumber
 \frac{Var[n_{p.e.}]}{(E[n_{p.e.}])^2} \cdot \frac{1}{E[N_{abs}]} + \frac{Var[G]}{(E[G])^2} \cdot \frac{1}{E[N_{p.e.}]}
\end{eqnarray}

Рассмотрим каждое из слагаемых подробнее.

Слагаемое $\frac{Var[N_{born}]}{(E[N_{born}])^2}$ описывает вклад флуктуации числа фотонов, рожденных в сцинтилляторе.
 Стоит заметить, что $Var[N_{born}] \neq E[N_{born}] $, то есть пуассоновская статистика не выполняется.
 Детальное описание факторов, влияющих на собственное энергетическое разрешение сцинтиллятора можно найти в \cite{Qi_Li}.

Выражение $\frac{Var[n_{abs}]}{(E[n_{abs}])^2} \cdot \frac{1}{E[N_{born}]}$ описывает вклад флуктуаций сбора света на фотокатод.
Существует множество факторов, влияющих на величину флуктуации: разброс точки взаимодействия рентгеновского кванта и сцинтиллятора,
флуктуации поглощения световых фотонов в толще сцинтиллятора, оптической смазки или фотокатода и т.д.
Чтобы найти эту величину, необходимо смоделировать распространите света в сцинтилляторе.
Также тут присутствует фактор подавления $\frac{1}{E[N_{born}]}$: чем больше число рожденных фотонов, тем меньше светосбор влияет на энергетическое разрешение.

Следующее слагаемое $\frac{Var[n_{p.e.}]}{(E[n_{p.e.}])^2} \cdot \frac{1}{E[N_{abs}]}$ описывает флуктуации числа регистрируемых фотонов, вызванные конечной квантовой эффективностью ФЭУ.
Это слагаемое можно упростить до следующего вида: $\frac{1 - \varepsilon}{\varepsilon} \cdot \frac{1}{E[N_{abs}]}$.


Последнее слагаемое $\frac{Var[G]}{(E[G])^2} \cdot \frac{1}{E[N_{p.e.}]}$ описывает флуктуации усиления. Флуктуации усиления $\frac{\sqrt{Var[G]}}{E[G]}$ обычно не превышают $10-20\%$ \cite{Characterization and Simulation of the Response}, а наличие фактора подавления $E[N_{p.e.}]$ делает вклад данного слагаемого в энергетическое разрешение еще меньше.

Рассмотрим теперь вклад каждого слагаемого в энергетическое разрешение в зависимости от энергии регистрируемого гамма кванта.
Для примера возьмем сцинтиллятор LYSO:Ce и ФЭУ с квантовой эффективностью 28\%.
Данные о непропорциональности световыхода и собственное энергетическое разрешение сцинтиллятора LYSO:Ce взяты из \cite{Light output and energy resolution}.
Чтобы получить флуктуации светосбора $\frac{\sqrt{Var[n_{abs}]}}{E[n_{abs}]}$, в программе GEANT4 был смоделирован детектор, аналогичный тому, что представлен на рис.~\ref{ris:image}.
Флуктуации составили около 10\%.
Также из моделирования была получена величина $E[n_{abs}]$, варьирующаяся в зависимости от размера сцинтиллятора и материала отражателя от 0.2 до 0.6.
В дальнейшем будем считать для определенности, что $E[n_{abs}] = 0.5$. Флуктуации усиления $\frac{\sqrt{Var[G]}}{E[G]}$ примем за 10\%.
Таким образом, получим следующие зависимости факторов от энергии гамма-кванта (рис.~\ref{image:YAP_Ce_PMT_simple_case}).
На рис.~\ref{image:YAP_Ce_PMT_simple_case} не представлены вклады флуктуации светосбора и коэффициента усиления,
т.к. они пренебрежимо малы относительно собственного энергетического разрешения сцинтиллятора и флуктуаций, связанных с неэффективностью детектора.

\begin{figure}[h]
\center{\includegraphics[width=8cm]{YAP_Ce_PMT_simple_case}}
\caption{Энергетическое разрешение детектора на основе YAP:Ce и ФЭУ с квантовой эффективностью 28\%. Светосбор равен 50\%.}
\label{image:YAP_Ce_PMT_simple_case}
\end{figure}

Итого, пренебрегая вкладами флуктуаций светосбора и усиления и пользуясь тем, что $E[n_{p.e.}] = \varepsilon$,
с достаточно хорошей точность можно использовать следующую формулу для вычисления энергетического разрешения:
\begin{eqnarray}\label{eq:ener_resol_base}
{\delta E}^2 / \Delta^2 \approx \frac{Var[N_{born}]}{(E[N_{born}])^2} + \frac{1 - \varepsilon}{N_{p.e.}}
\end{eqnarray}

\subsection{Учет собственных шумов ФЭУ и шумов электроники}
В предыдущем разделе описана самая простая формула для энергетического разрешения.
Однако, для полноты картины, следует учесть еще шум ФЭУ и шум электроники.

Отличие от предыдущего случая будет в том, что теперь в итоговый заряд будет давать вклад не только сигнал, но и шум. Чтобы выделить сигнал, необходимо вычесть шум из измерений:
$$N_e^{signal} = N_e^{signal + noise} - N_e^{noise}$$

При вычислении мат. ожидания вклад шумов сократится, а дисперсия сигнала будет зависеть от дисперсии шумов.
Шум может быть обусловлен темновыми токами ФЭУ $N_e^{DC}$ и шумом электроники $N_e^{electronics}$.
При работе с ФЭУ или SiPM усиление обычно достаточно велико и вкладом шума электроники можно пренебречь.
Таким образом, получим следующую формулу для вычисления энергетического разрешения:
\begin{eqnarray}\label{eq:ener_resol_noise}
\delta E = \Delta \cdot \frac{ \sqrt{ Var[N_e^{signal}] + 2 \cdot Var[N_e^{DC}] } }{E[N_e^{signal}]}
\end{eqnarray}

Если раньше предполагалось бесконечное время интегрирования сигнала, то теперь оно конечно.
Обозначим его $t_{gate}$. Предположим, что время интегрирования в несколько раз больше характерного времени затухания сигнала
и мы собираем практически весь заряд от сигнала, т.е. величина $N_e^{signal}$ не зависит от $t_{gate}$.
Число регистрируемых шумовых фотоэлектронов $N_{p.e.}^{DC}$ будет подчиняться статистике Пуассона с параметром, равным произведению времени интегрирования $t_{gate}$ на частоту шумовых импульсов $\nu_{DC}$.
В этом случае величина $N_e^{DC}$ будет вычисляться следующим образом:

$$ N_e^{DC} = \sum \limits_{i=0}^{N_{p.e.}^{DC}} G_{i}, $$

причем $E[N_{p.e.}^{DC}] = Var[N_{p.e.}^{DC}] = t_{gate} \cdot \nu_{DC}$.

На рис.~\ref{image:ER_noise} изображена зависимость энергетического разрешения детектора на основе ФЭУ и сцинтиллятора YAP:Ce от величины темновых токов.

\begin{figure}[h]
\center{\includegraphics[width=8cm]{ER_noise}}
\caption{Энергетическое разрешение детектора на основе YAP:Ce и ФЭУ с квантовой эффективностью 28\%.
 Светосбор равен 50\%. Различные графики соответствуют различным значениям зарегистрированных темновых токов.}
\label{image:ER_noise}
\end{figure}

Время высвечивания сцинтиллятора YAP:Ce составляет около 25 нс, а шумы ФЭУ при комнатной температуре не превышают 1 кГц, поэтому вклад темновых токов в энергетическое разрешение пренебрежимо мал.
Если рассмотреть в качестве детектора SiPM у которого шум при комнатной температуре около 1 МГц / 1 $мм^2$ и пренебречь кроссстоками и послеимпульсами,
то и в этом случае вклад в энергетическое разрешение шумов будет мал.

\section{Энергетическое разрешение SiPM}
С точки зрения энергетического разрешения SiPM отличается от ФЭУ наличием двух дополнительных факторов, влияющих на шум: послеимпульсами и кросстоками.

\subsection{Учет кросстоков}

Кроссток или оптический кроссток - это эффект срабатывания соседних ячеек SiPM из-за излучения оптических фотонов во время образования лавины в исходном пикселе.
Поскольку свет распространяется практически мгновенно, то данный эффект не приводит к каким-либо временным сдвигам. Чтобы учесть влияние кросстока на энергетическое разрешение,
необходимо модифицировать функцию плотности вероятности величины $n_{p.e.}$.
Если раньше данная величина имела распределение Бернулли с параметром $E[n_{p.e.}]$, то теперь распределение будет другим.
Чтобы найти это распределение нужно знать квантовую эффективность регистрации (или коэффициент конверсии,
т.к. все зависит от того, какую величину рассматривать в качестве базовой) и вероятность срабатывания соседней ячейки из-за кросстока.
Детальное описание вероятностей срабатывания ячеек из-за кросстока можно найти в \cite{Modeling crosstalk in silicon photomultipliers}.
В этой статье рассматриваются несколько моделей распространения фотонов, но утверждается, что для большинства моделей SiPM наиболее правдоподобной является модель 4-х соседей.
Вероятность срабатывания N ячеек выражается через параметр $p$, который описывает вероятность того, что соседний пиксель сработает из-за кросстока.
Вычислить параметр $p$ можно, зная полную вероятность кросстока $p_{total}$ (одно или больше кросстоковых событий): $(1 - p)^{4} = 1 - p_{total}$.
В дальнейшем удобно будет ввести величину $q = 1 - p$.
Таким образом, зная квантовую эффективность $\varepsilon$ и вероятность кросстока $p$, получим следующую плотность вероятности в модели 4-х соседей.

\begin{table}[h]
\caption{Плотность вероятности $n_{p.e.}$ в модели 4-х соседей}
\label{table:n_p.e.}
\begin{center}
\begin{tabular}{|c|c|}
  \hline
  суммарное число сработавших ячеек& плотность вероятности $n_{p.e.}$ \\
  \hline

  \hline
  1 & $\varepsilon \cdot q^4$ \\
  \hline
  2 & $\varepsilon \cdot 4  p \cdot q^6$ \\
  \hline
  3 & $ \varepsilon \cdot 18  p^2 \cdot q^8$ \\
  \hline
  4 & $\varepsilon \cdot 4  p^3 \cdot q^8 [1 + 3q + 18 q^2]$ \\
  \hline
  5 & $\varepsilon \cdot 5  p^4 \cdot q^{10} [8 + 24q + 55q^2]$ \\
  \hline
  $N > 5$ & $\simeq\varepsilon \cdot P(5) \left[ 1 - \frac{P(5)}{1 - \sum \limits_{k=1}^{4} P(k) } \right]^{N - 5}$ \\
  \hline
\end{tabular}
\end{center}
\end{table}

На Рис.~\ref{x-talk:image} показана зависимость среднего числа регистрируемых ячеек в зависимости от величины кросстока.

\begin{figure}[h]
\center{\includegraphics[width=8cm]{x-talk}}
\caption{Зависимость среднего числа регистрируемых ячеек в зависимости от величины кросстока.}
\label{x-talk:image}
\end{figure}


Чтобы учесть вклад кросстоков в энергетическое разрешение необходимо пересчитать $E[n_{p.e}]$ и $Var[n_{p.e.}]$ с учетом модифицированной плотности вероятности.


Если учесть еще и собственные шумы SiPM при наличии кросстока, то необходимо изменить величину $N_{p.e.}^{DC}$:
\begin{eqnarray}
N_{p.e.}^{DC} = \sum \limits_{i=0}^{N^{DC}} n_{p.e._{i}}^{DC}, \nonumber
\end{eqnarray}

где величина $n_{p.e.}^{DC}$ - число зарегистрированных фотоэлектронов, если произошел одиночный шумовой (тепловой) импульс.
Данная величина имеет тоже распределение,что и $n_{p.e.}$, только с параметром $\varepsilon = 1$.
Величина $N^{DC}$ имеет распределение Пуассона с параметром $t_{gate} \cdot \nu_{DC}$.
Таким образом, получим следующие значения для мат. ожидания и дисперсии:


$$E[N_{p.e.}] = E[n_{p.e.}] \cdot E[N_{abs}]  $$
$$E[N_{p.e.}^{DC}] = E[n_{p.e.}^{DC}] \cdot E[N^{DC}]  $$
$$ Var[N_{p.e.}] = Var[N_{abs}] \cdot \left( E[n_{p.e.}] \right)^2 + Var[n_{p.e.}] \cdot E[N_{abs}]  $$
$$Var[N_{p.e.}^{DC}] = Var[N^{DC}] \cdot \left( E[n_{p.e.}^{DC}] \right)^2 + Var[n_{p.e.}^{DC}] \cdot E[N^{DC}] $$

При учете кросстоков вид формулы для энергетического разрешения останется прежний (\ref{eq:ener_resol_noise}).


На рис.~\ref{ER_x-talk:image} представлена зависимость энергетического разрешения от энергии фотона при различных значениях кросстока.

\begin{figure}[h]
\center{\includegraphics[width=8cm]{ER_x-talk}}
\caption{Энергетическое разрешение детектора на основе YAP:Ce и SiPM с квантовой эффективностью 28\%.
Светосбор равен 50\%. Различные графики соответствуют различным значениям вероятности кросстока.
Темновые токи отсутствуют.}
\label{ER_x-talk:image}
\end{figure}

\subsection{Учет послеимпульсов}

Послеимпульс - срабатывание ячейки, происходящее через некоторый промежуток времени после предыдущего срабатывания ячейки.
Причина появления послеимпульсов заключается в захвате электронов в ловушки во время лавины с их последующим высвобождение через промежуток времени,
обычно длящийся от нескольких наносекунд до нескольких микросекунд \cite{Characterisation Studies of Silicon Photomultipliers}.
После срабатывания первичного сигнала напряжение на ячейке уменьшится до напряжения пробоя и  далее будет восстанавливаться к исходному значению по экспоненциальному закону:

\begin{eqnarray}\label{eq:V_current}
V_{current} = V_{bias} \cdot (1 - \exp \left( -\Delta t / \tau_{rec} \right)),
\end{eqnarray}

где $V_{bias}$ - рабочее напряжение SiPM, $\tau_{rec}$ - время восстановления ячейки.

Существует несколько процессов, которые могут вызвать повторное срабатывание ячейки.
Во-первых, это послеимпульсы. Из-за наличия различных физических механизмов образования электронных ловушек существуют два вида
послеимпульсов: с быстрой и медленной компонентой \cite{After-pulsingandcross-talkinmulti-pixelphotoncounters, Using MPPCs for T2K Fine Grain Detector, Characterization and Simulation of the Response}.
Во-вторых, повторное срабатывание ячейки могут вызвать темновые токи.
Каждый из этих трех процессов имеет экспоненциальное время распределения со своим собственным временем $\tau$:
\begin{eqnarray}\label{eq:f(dt)_afterpulsing}
f(\Delta t) = \frac{1}{\tau} \cdot \exp(-\Delta t / \tau),
\end{eqnarray}
где $\tau$ - среднее время, проходящее между двумя импульсами при рассмотрении лишь одного из вышеперечисленных эффектов.
В реальности каждый из этих процессов может приводить к срабатыванию ячейки.

\subsubsection{Распределение временных интервалов}

Поскольку мы интересуемся плотностью временных интервалов, то необходимо узнать вероятность $P(t)$ того, что на участке от $0$ до $t$ не должно быть импульсов, а на участке от $t$ до $t + \delta t$ должен произойти один импульс.

Если рассматривать лишь один экспоненциальный процесс, то эта вероятность есть $P_{exp}(t) =  \nu \cdot e^{- t \cdot \nu} \cdot \delta t$.

Выведем плотность вероятности для временных интервалов, если в ячейке могут происходить послеимпульсы или темновые импульсы.
Для начала рассмотрим случай, когда имеются послеимпульсы только одного типа, происходящие с вероятностью $p$ и временем $\nu$.
Темновые импульсы, как и послеимпульсы имеют экспоненциальное распределение (\ref{eq:f(dt)_afterpulsing}).
Поскольку темновые импульсы не зависят от послеимпульсов, то искомую вероятность $P(t)$ можно записать следующим образом:

\begin{eqnarray}\label{eq:probability_dt_simple}
P(t) = P\{ \text{нет послеимпульсов от $0$ до $t + \delta t$} \} 
\cdot P\{ \text{есть темновой импульс от $t$ до $t + \delta t$} \} +  \\ \nonumber
P\{ \text{есть послеимпульс от $t$ до $t + \delta t$} \}
\cdot P\{\text{нет темнового импульса от $0$ до $t + \delta t$} \}
\end{eqnarray}

Вклад каждого из процессов будет следующий:
\begin{eqnarray}\label{eq:probability_dt_simple_parts}
P\{ \text{нет послеимпульсов от $0$ до $t + \delta t$} \} = (1 - p) + p \cdot e^{- \nu \cdot t} \\ \nonumber
P\{ \text{есть темновой импульс от $t$ до $t + \delta t$} \} = (\nu_{dc} \cdot e^{- \nu_{dc} \cdot t}) \cdot \delta t \\ \nonumber
P\{ \text{есть послеимпульс от $t$ до $t + \delta t$} \} = p \cdot ( \nu \cdot e^{- \nu \cdot t} ) \cdot \delta t  \\ \nonumber
P\{\text{нет темнового импульса от $0$ до $t + \delta t$} \} = e^{- \nu_{dc} \cdot t} \\ \nonumber
\end{eqnarray}

Таким образом, подставив значения вероятностей из (\ref{eq:probability_dt_simple_parts}) в (\ref{eq:probability_dt_simple}) и сократив итоговое выражение на $\delta t$, получим плотность вероятности временных интервалов:
\begin{eqnarray}\label{eq:probability_dt_fast}
f(t) = p \cdot (\nu + \nu_{dc}) \cdot e^{-(\nu + \nu_{dc}) \cdot t} + (1 - p) \cdot \nu_{dc} \cdot e^{-\nu_{dc} \cdot t}
\end{eqnarray}

Стоит отметить, что аналогичная формула приведена в \cite{Using MPPCs for T2K Fine Grain Detector}, страница 8, однако допущена ошибка в знаке между слагаемыми.

В итоге при учете быстрых и медленных послеимпульсов и темновых токов плотность вероятности распределения временных интервалов запишется следующим образом:
\begin{eqnarray}\label{eq:dt_probability_fast_slow}
f(t) = p_{s} \cdot p_{f} \cdot (\nu_{s} + \nu_{f} + \nu_{dc} ) \cdot e^{- (\nu_{s} + \nu_{f} + \nu_{dc}) \cdot t} + \\ \nonumber
p_{s} \cdot (1 - p_{f}) \cdot (\nu_{s} + \nu_{dc}) \cdot e^{- (\nu_{s} + \nu_{dc}) \cdot t} + \\ \nonumber
p_{f} \cdot (1 - p_{s}) \cdot (\nu_{f} + \nu_{dc}) \cdot e^{- (\nu_{f} + \nu_{dc}) \cdot t} + \\ \nonumber
(1 - p_{s}) \cdot (1 - p_{f}) \cdot \nu_{dc} \cdot e^{- \nu_{dc} \cdot t}
\end{eqnarray}

В статье \cite{After-pulsingandcross-talkinmulti-pixelphotoncounters} приведен другой результат для плотности временных интервалов, отличный от полученного в данной работе.


\subsubsection{Распределение добавочного заряда}
В большинстве приложений время интегрирования $t_{gate}$ выбирают в несколько раз больше времени восстановления ячейки $\tau_{r}$.
Мы предположим что, $t_{gate}$ достаточно большое и в несколько раз превышает $\tau_{fast}$ и $\tau_{slow}$.
Это условие будет гарантировать, что с большой долей вероятности все послеимпульсы будут собраны за время не превышающее $t_{gate}$.

Чтобы учесть вклад послеимпульсов в энергетическое разрешение необходимо ввести поправку
 на число зарегистрированных электронов:
$$N_{e} = \sum \limits_{i=0}^{N_{p.e.}} (G_{i} + A_{i}) $$

Случайная величина $G$ имеет распределение Гаусса и описывает по-прежнему флуктуации усиления, а величина $A$ описывает послеимпульсы.
Мат. ожидание и дисперсия величины $G_{tot} = G + A$ находятся из эксперимента.

Теоретически можно найти зависимость плотности вероятности величины $G_{tot}$ от различных параметров детектора.
Предположим, что заряд, собираемый с полностью разряженной ячейки, равен 1.
Тогда если через время $\Delta t$ после срабатывания предыдущего сигнала ячейка сработает еще раз,
то заряд, собранный с ячейки, увеличится на величину $\xi(\Delta t)$:
\begin{eqnarray}\label{eq:xi_afterpulsing}
\xi(\Delta t) = 1 - \exp \left( -\Delta t / \tau_{rec} \right)
\end{eqnarray}

Найдем плотность вероятности добавочного заряда послеимпульса $\xi(\Delta t)$.
Предположим, что на каждый первоначальный импульс будет образовываться только один послеимпульс и существует лишь один процесс, приводящий к появлению добавочного заряда.
В этом случае величина $\xi(\Delta t)$ из уравнения (\ref{eq:xi_afterpulsing}) будет иметь следующую плотность вероятности:
\begin{eqnarray}\label{eq:g(xi)_afterpulsing}
g(\xi) = \frac{\tau_{rec}}{1 - \xi} \cdot f\left(-\tau_{rec} \cdot ln(1 - \xi)\right)
\end{eqnarray}

Функция $f$ - это плотность вероятности расстояния между сигналами (\ref{eq:f(dt)_afterpulsing}) при учете лишь одного процесса.
Подставив (\ref{eq:f(dt)_afterpulsing}) в (\ref{eq:g(xi)_afterpulsing}) получим:
\begin{eqnarray}\label{eq:g(xi)_detail_afterpulsing}
g(\xi) = \alpha \cdot (1 - \xi)^{\alpha - 1}, \text{где }  \alpha = \tau_{rec} / \tau
\end{eqnarray}
Плотность вероятности добавочного заряда приведена на рис.~\ref{image:amp_probability_one_pixel}.

\begin{figure}[h]
\center{\includegraphics[width=8cm]{amp_probability_one_pixel}}
\caption{Плотность вероятности добавочного заряда послеимпульса}
\label{image:amp_probability_one_pixel}
\end{figure}

Если учесть, что послеимпульсы происходят с некоторой вероятностью $p$, то плотность распределения можно представить в виде:
\begin{eqnarray}\label{eq:g(xi)_afterpulsing_4}
g(\xi) = p \cdot \alpha \cdot (1 - \xi)^{\alpha - 1} + (1 - p) \cdot \delta(\xi - 1)
\end{eqnarray}

Если считать, что ячейка может сработать как от послеимпульсов с быстрой компонентой, так и с медленной, то формула (\ref{eq:g(xi)_afterpulsing_4})
запишется следующим образом:
\begin{eqnarray}\label{eq:g(xi)_afterpulsing_3}
g(\xi) = p_{s} \cdot \alpha_{s} \cdot (1 - \xi)^{\alpha_{s} - 1} + p_{f} \cdot \alpha_{f} \cdot (1 - \xi)^{\alpha_{f} - 1} + (1 - p_{s} - p_{f}) \cdot \delta(\xi - 1), \\ \nonumber
\text{где } \alpha_{s} = \tau_{rec} / \tau_{s}, \alpha_{f} = \tau_{rec} / \tau_{f}
\end{eqnarray}

Наконец, чтобы учесть неидеальность детектора необходимо свернуть полученное распределение (\ref{eq:g(xi)_afterpulsing_3}) с гауссовым распределением:
\begin{eqnarray}\label{eq:g(xi)_afterpulsing_final}
G_{tot}(\xi) = g(\xi) * Gauss(\sigma) \cdot E[G]
\end{eqnarray}
Параметр $\sigma$ характеризует ширину распределения при отсутствии послеимпульсов, а величина $E[G]$ - усиление SiPM.
Данный интеграл не берется в аналитических функциях, поэтому мы посчитаем мат. ожидание и дисперсию в предположении, что нет флуктуаций усиления:
\begin{eqnarray}\label{eq:G_tot_ENF_approx}
\frac{ Var[G_{tot}] }{ (E[G_{tot}])^2 } = \frac{ Var[\xi] }{ (E[\xi])^2 } = \frac{ E[\xi^2] - (E[\xi])^2 }{ (E[\xi])^2 }\text{, где} \\
E[\xi] = (1 - p_s - p_f) + \frac{p_s}{1 + \alpha_s} + \frac{p_f}{1 + \alpha_f} \\
E[\xi^2] = (1 - p_s - p_f) + p_s \cdot \alpha_s \cdot B(3, \alpha_s) + p_f \cdot \alpha_f \cdot B(3, \alpha_f)
\end{eqnarray}

\subsection{Избыточный фактор шума}
Рассчитаем избыточный фактор шума $ENF$ для детектора.
$ENF$ определяется как квадрат отношения значения сигнал / шум на входе ($SNR_{in}$) к значению сигнал / шум на выходе ($SNR_{out}$):

\begin{eqnarray}\label{eq:ENF}
ENF = SNR_{in}^2 / SNR_{out}^2
\end{eqnarray}

Значение $SNR_{in}^2$ определяется как отношение квадрата мат. ожидания числа зарегистрированных фотоэлектронов без учета кросстоков к дисперсии этого числа:
\begin{eqnarray}\label{eq:SNR_in}
SNR_{in}^2 = ( E[N_{p.e}^{no X-talk}] )^2 / Var[N_{p.e}^{no X-talk}]
\end{eqnarray}

Мы предполагаем, что число зарегистрированных фотоэлектронов $N_{p.e}^{no X-talk}$ имеет Пуассоновское распределение, поэтому $SNR_{in}^2 = N_{p.e}^{no X-talk}$

Значение $SNR_{out}^2$ определяется аналогичным образом, где мат. ожидание и дисперсия вычисляются для числа зарегистрированных электронов:
\begin{eqnarray}\label{eq:SNR_out}
SNR_{out}^2 = ( E[N_{e}] )^2 / Var[N_{e}]
\end{eqnarray}

Величина $SNR_{out}^2$ связана с энергетическим разрешением следующим образом:
\begin{eqnarray}\label{eq:SNR_E_esol_relation}
SNR_{out}^2 = 1 / \frac{ Var[N_{e}] }{ (E[N_{e}] )^2 } = 1 / \frac{\delta E^2}{ \Delta^2 }
\end{eqnarray}

Таким образом, получим следующее выражение для $ENF$:
\begin{eqnarray}\label{eq:ENF_var2}
ENF = \frac{\delta E^2}{ \Delta^2 } \cdot E[N_{p.e}^{no X-talk}]
\end{eqnarray}

Для начала предположим, что SiPM не имеет шумов. Если подставим (\ref{eq:ener_resol_base}) в (\ref{eq:ENF_var2}), то получится следующее выражение для $ENF$:
\begin{eqnarray}\label{eq:ENF_var2}
ENF = 1 + \frac{Var[n_{p.e.}]}{(E[n_{p.e.}])^2} + \frac{ Var[G_{tot}] }{ (E[G_{tot}])^2 } \cdot \frac{1}{E[n_{p.e.}]}
\end{eqnarray}

$ENF$ позволяет учесть неидеальность детектора, связанную с кросстоками, послеимпульсами и флуктуациями усиления.
Распределение величины $n_{p.e.}$ в данном случае рассматривается при 100\% квантовой эффективности.

В случае наличия шума энергетическое разрешение изменится (\ref{eq:ener_resol_noise}).
$ENF$ можно записать как сумму $ENF_{no\; noise}$ без учета шумов и $ENF_{noise}$ и с их учетом, где $ENF_{no\; noise}$ приведен в формуле (\ref{eq:ENF_var2}).
В результате получим:
\begin{eqnarray}\label{eq:ENF_noise}
ENF = ENF_{no\; noise} + ENF_{noise} = ENF_{no\; noise} \cdot \left(1 + \frac{2 t_{gate} \cdot \nu_{DC}}{ ( E[N_{p.e}^{no X-talk}] )^2 } \right)
\end{eqnarray}

При реальных измерениях легко выбрать такой световой поток, чтобы величина $2 t_{gate} \cdot \nu_{DC} / ( E[N_{p.e}^{no X-talk}] )^2 $ была мала, поэтому можно пользоваться соотношением
\begin{eqnarray}\label{eq:ENF_approx}
ENF \approx ENF_{no\; noise}
\end{eqnarray}

\subsection{Предельное энергетическое разрешение SiPM}
Проанализировав основные факторы, влияющие на энергетическое разрешение SiPM, перед нами встает важный вопрос:
какое предельное достижимое энергетическое разрешение SiPM?
Для начала рассмотрим 
